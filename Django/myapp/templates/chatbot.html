{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Tour Guide - Chat</title>
  <link rel="preload" as="style" href="{% static 'css/navbar.css' %}" onload="this.rel = 'stylesheet'" />
  <link rel="preload" as="style" href="{% static 'css/chatbot.css' %}" onload="this.rel = 'stylesheet'" />
  <style>
    /* Enhanced chatbot styles */
    .chatbot-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .chat-messages {
      background: #1a1a2e;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .message {
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 10px;
    }
    
    .user-message {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: 20%;
    }
    
    .bot-message {
      background: #16213e;
      color: #e0e0e0;
      margin-right: 20%;
      border-left: 4px solid #c9a227;
    }
    
    .message-header {
      font-weight: bold;
      margin-bottom: 8px;
      color: #c9a227;
    }
    
    .message-content {
      line-height: 1.6;
      white-space: pre-wrap;
    }
    
    /* Sources section */
    .sources-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #2a2a4e;
    }
    
    .sources-title {
      color: #c9a227;
      font-size: 0.9em;
      margin-bottom: 10px;
    }
    
    .source-item {
      background: #0f0f23;
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      font-size: 0.85em;
      color: #a0a0a0;
    }
    
    /* Images section */
    .images-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #2a2a4e;
    }
    
    .images-title {
      color: #c9a227;
      font-size: 0.9em;
      margin-bottom: 10px;
    }
    
    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
    }
    
    .image-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .image-item img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    
    .image-item img:hover {
      transform: scale(1.05);
    }
    
    .image-caption {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 0.7em;
      padding: 5px;
      text-align: center;
    }
    
    /* Input section */
    .chat-input-section {
      background: #1a1a2e;
      border-radius: 12px;
      padding: 20px;
    }
    
    .chat-form {
      display: flex;
      gap: 10px;
    }
    
    .chat-input-wrapper {
      flex: 1;
    }
    
    .chat-input {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 8px;
      background: #16213e;
      color: white;
      font-size: 1em;
      resize: none;
    }
    
    .chat-input:focus {
      outline: 2px solid #c9a227;
    }
    
    .chat-btn {
      padding: 15px 30px;
      background: linear-gradient(135deg, #c9a227 0%, #d4af37 100%);
      color: #1a1a2e;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .chat-btn:hover {
      transform: scale(1.05);
    }
    
    .chat-btn:disabled {
      background: #666;
      cursor: not-allowed;
    }
    
    /* Loading indicator */
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    
    .loading.active {
      display: block;
    }
    
    .loading-spinner {
      border: 4px solid #2a2a4e;
      border-top: 4px solid #c9a227;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Document count */
    .docs-count {
      font-size: 0.8em;
      color: #888;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  {% include 'partial/navbar.html' %}
  
  <div class="chatbot-container">
    <h2 class="section-title">üèõÔ∏è Ancient Egypt AI Tour Guide</h2>
    <p style="text-align: center; color: #888; margin-bottom: 20px;">
      Ask questions about Ancient Egyptian history, pharaohs, pyramids, and more!
    </p>
    
    <!-- Chat Messages Area -->
    <div class="chat-messages" id="chat-messages">
      {% if response %}
      <div class="message user-message">
        <div class="message-header">You</div>
        <div class="message-content">{{ request.POST.user_input }}</div>
      </div>
      
      <div class="message bot-message">
        <div class="message-header">ü§ñ AI Tour Guide</div>
        <div class="message-content">{{ response.answer }}</div>
        
        {% if response.documents_found > 0 %}
        <div class="docs-count">üìö Found {{ response.documents_found }} relevant documents</div>
        {% endif %}
        
        {% if response.sources %}
        <div class="sources-section">
          <div class="sources-title">üìñ Sources:</div>
          {% for source in response.sources|slice:":3" %}
          <div class="source-item">{{ source|truncatewords:50 }}</div>
          {% endfor %}
        </div>
        {% endif %}
        
        {% if response.images %}
        <div class="images-section">
          <div class="images-title">üñºÔ∏è Related Images:</div>
          <div class="images-grid">
            {% for image in response.images %}
            <div class="image-item">
              <a href="{{ image.url }}" target="_blank">
                <img src="{{ image.url }}" alt="{{ image.title|default:'Related image' }}" 
                     onerror="this.style.display='none'">
              </a>
              {% if image.title %}
              <div class="image-caption">{{ image.title|truncatewords:5 }}</div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
      {% else %}
      <div class="message bot-message">
        <div class="message-header">ü§ñ AI Tour Guide</div>
        <div class="message-content">Welcome! I'm your AI guide to Ancient Egypt. Ask me anything about:
‚Ä¢ Pharaohs and dynasties
‚Ä¢ Pyramids and temples
‚Ä¢ Egyptian gods and mythology
‚Ä¢ Hieroglyphics and writing
‚Ä¢ Daily life in ancient Egypt
‚Ä¢ Mummies and burial practices</div>
      </div>
      {% endif %}
      
      <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div>Searching documents and generating response...</div>
      </div>
    </div>
    
    <!-- Chat Input Section -->
    <div class="chat-input-section">
      <form method="POST" class="chat-form" id="chat-form">
        {% csrf_token %}
        <div class="chat-input-wrapper">
          <textarea name="user_input" class="chat-input" 
                    placeholder="Ask something about Ancient Egypt..." 
                    rows="2" required></textarea>
        </div>
        <button type="submit" class="chat-btn" id="submit-btn">
          Ask üîç
        </button>
      </form>
    </div>
    
    <!-- Recent Chat History -->
    {% if chat_history %}
    <div style="margin-top: 30px;">
      <h3 style="color: #c9a227;">Recent Conversations</h3>
      {% for chat in chat_history|slice:":5" %}
      <div style="background: #16213e; padding: 10px; margin: 5px 0; border-radius: 5px;">
        <div style="color: #888; font-size: 0.8em;">{{ chat.timestamp|date:"M d, Y H:i" }}</div>
        <div style="color: #c9a227;">Q: {{ chat.user_input|truncatewords:20 }}</div>
        <div style="color: #e0e0e0;">A: {{ chat.bot_response|truncatewords:30 }}</div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>

  <script>
    // Show loading indicator on form submit
    document.getElementById('chat-form').addEventListener('submit', function() {
      document.getElementById('loading').classList.add('active');
      document.getElementById('submit-btn').disabled = true;
      document.getElementById('submit-btn').textContent = 'Thinking...';
    });
    
    // Scroll to bottom of chat
    var chatMessages = document.getElementById('chat-messages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
  </script>
  <script src="{% static 'js/chatbot.js' %}"></script>
</body>
</html>