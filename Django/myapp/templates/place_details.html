{% load static %}
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Place details ‚Äî AI Tour Guide</title>
  <link rel="stylesheet" href="{% static 'css/navbar.css' %}"/>
  <link rel="stylesheet" href="{% static 'css/place_details.css' %}"/>
</head>
<body>
  {% include 'partial/navbar.html' %}

  <div class="place-details-page">
    <header class="place-details-hero">
      <span class="place-details-hero-icon" aria-hidden="true">üèõÔ∏è</span>
      <h1>Place details</h1>
      <p class="place-details-intro">Discover visitor info for any location. Use your current position, type a place or address, or choose from famous sites.</p>
    </header>

    <div class="place-details-cards">
      <section class="place-card">
        <div class="place-card-header">
          <span class="place-card-icon" aria-hidden="true">üìç</span>
          <h2 class="place-option-title">Current location</h2>
        </div>
        <p class="place-option-desc">Get AI-generated details for where you are now.</p>
        <button type="button" id="use-location-btn" class="btn btn-secondary">
          <span class="btn-icon">üìç</span> Use my location
        </button>
      </section>

      <section class="place-card">
        <div class="place-card-header">
          <span class="place-card-icon" aria-hidden="true">‚úèÔ∏è</span>
          <h2 class="place-option-title">Search by name</h2>
        </div>
        <p class="place-option-desc">Enter any place name or address.</p>
        <div class="place-details-inputs">
          <input type="text" id="place-name-input" placeholder="e.g. Great Pyramid of Giza, Luxor Temple‚Ä¶" autocomplete="off" />
        </div>
        <button type="button" id="get-details-btn" class="btn btn-primary">
          <span class="btn-icon">‚ú®</span> Get details
        </button>
      </section>

      <section class="place-card recommended-section">
        <div class="place-card-header">
          <span class="place-card-icon" aria-hidden="true">‚≠ê</span>
          <h2 class="place-option-title">Recommended sites</h2>
        </div>
        <p class="place-option-desc">Famous Egyptian and tourist spots ‚Äî click to explore.</p>
        <div class="recommended-grid" id="recommended-grid">
          <button type="button" class="recommended-chip" data-place="Great Pyramid of Giza">Great Pyramid of Giza</button>
          <button type="button" class="recommended-chip" data-place="Great Sphinx of Giza">Great Sphinx of Giza</button>
          <button type="button" class="recommended-chip" data-place="Pyramids of Giza">Pyramids of Giza</button>
          <button type="button" class="recommended-chip" data-place="Luxor Temple">Luxor Temple</button>
          <button type="button" class="recommended-chip" data-place="Valley of the Kings">Valley of the Kings</button>
          <button type="button" class="recommended-chip" data-place="Karnak Temple">Karnak Temple</button>
          <button type="button" class="recommended-chip" data-place="Abu Simbel">Abu Simbel</button>
          <button type="button" class="recommended-chip" data-place="Egyptian Museum Cairo">Egyptian Museum, Cairo</button>
          <button type="button" class="recommended-chip" data-place="Temple of Hatshepsut">Temple of Hatshepsut</button>
          <button type="button" class="recommended-chip" data-place="Philae Temple">Philae Temple</button>
          <button type="button" class="recommended-chip" data-place="Cairo Citadel">Cairo Citadel</button>
          <button type="button" class="recommended-chip" data-place="Alexandria Lighthouse">Lighthouse of Alexandria</button>
        </div>
      </section>
    </div>

    <div id="place-status" class="place-details-status" aria-live="polite"></div>

    <article id="place-result" class="place-details-result" style="display: none;" aria-labelledby="result-place-name">
      <div class="result-header">
        <span class="result-badge">Place details</span>
        <h2 class="result-place-name" id="result-place-name"></h2>
      </div>
      <div class="result-details result-details-sections" id="result-details"></div>
    </article>
  </div>

  <script>
(function () {
  var apiUrl = "{% url 'place_details_api' %}";
  var csrfToken = "{{ csrf_token }}";
  var statusEl = document.getElementById("place-status");
  var resultEl = document.getElementById("place-result");
  var resultNameEl = document.getElementById("result-place-name");
  var resultDetailsEl = document.getElementById("result-details");
  var placeInput = document.getElementById("place-name-input");
  var useLocationBtn = document.getElementById("use-location-btn");
  var getDetailsBtn = document.getElementById("get-details-btn");

  function setStatus(msg, isError, isLoading) {
    statusEl.textContent = msg || "";
    statusEl.className = "place-details-status" + (isError ? " error" : "") + (isLoading ? " loading" : "");
  }

  function escapeHtml(s) {
    var div = document.createElement("div");
    div.textContent = s;
    return div.innerHTML;
  }

  var SECTION_HEADERS = [
    { key: "intro", label: "Overview" },
    { key: "significance", label: "Significance" },
    { key: "what_to_see", label: "What to See" },
    { key: "practical_tips", label: "Practical Tips" },
    { key: "ancient_connection", label: "Ancient Connection" }
  ];

  function stripMarkdownAndEmoji(text) {
    if (!text) return "";
    var s = text.replace(/\*\*/g, "").replace(/\*/g, "");
    s = s.replace(/[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, "");
    return s.replace(/  +/g, " ").trim();
  }

  function sectionBodyToHtml(text) {
    if (!text) return "";
    var clean = stripMarkdownAndEmoji(text);
    return escapeHtml(clean).replace(/\n\n+/g, "<br><br>").replace(/\n/g, "<br>");
  }

  function renderSections(sections) {
    if (!sections || typeof sections !== "object") return "";
    var out = [];
    for (var i = 0; i < SECTION_HEADERS.length; i++) {
      var sh = SECTION_HEADERS[i];
      var body = sections[sh.key];
      if (!body || typeof body !== "string" || !body.trim()) continue;
      var bodyHtml = sectionBodyToHtml(body.trim());
      out.push(
        "<section class=\"result-section result-section-" + sh.key + "\" aria-labelledby=\"section-" + sh.key + "\">",
        "  <h3 class=\"result-section-title\" id=\"section-" + sh.key + "\">" + escapeHtml(sh.label) + "</h3>",
        "  <div class=\"result-section-body\">" + bodyHtml + "</div>",
        "</section>"
      );
    }
    return out.join("");
  }

  function showResult(placeName, detailsOrSections) {
    resultNameEl.textContent = placeName;
    if (detailsOrSections && typeof detailsOrSections === "object" && !Array.isArray(detailsOrSections)) {
      resultDetailsEl.innerHTML = renderSections(detailsOrSections);
    } else {
      var text = typeof detailsOrSections === "string" ? detailsOrSections : "";
      resultDetailsEl.innerHTML = "<div class=\"result-details-fallback\"><p>" + sectionBodyToHtml(text || "No details.") + "</p></div>";
    }
    resultEl.style.display = "block";
    resultEl.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function hideResult() {
    resultEl.style.display = "none";
  }

  function requestDetails(payload) {
    hideResult();
    setStatus("Loading place details‚Ä¶", false, true);
    var xhr = new XMLHttpRequest();
    xhr.open("POST", apiUrl);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.setRequestHeader("X-CSRFToken", csrfToken);
    xhr.onload = function () {
      setStatus("", false, false);
      var data;
      try {
        data = JSON.parse(xhr.responseText);
      } catch (e) {
        setStatus("Invalid response from server.", true);
        return;
      }
      if (data.success) {
        showResult(data.place_name, data.sections || data.details);
      } else {
        setStatus(data.error || "Something went wrong.", true);
      }
    };
    xhr.onerror = function () {
      setStatus("Network error. Please try again.", true);
      setStatus("", false, false);
    };
    xhr.send(JSON.stringify(payload));
  }

  getDetailsBtn.addEventListener("click", function () {
    var name = (placeInput.value || "").trim();
    if (!name) {
      setStatus("Enter a place name, use your location, or pick a recommended place.", true);
      return;
    }
    requestDetails({ place_name: name });
  });

  document.getElementById("recommended-grid").addEventListener("click", function (e) {
    var chip = e.target.closest(".recommended-chip");
    if (!chip) return;
    var place = chip.getAttribute("data-place");
    if (place) requestDetails({ place_name: place });
  });

  useLocationBtn.addEventListener("click", function () {
    if (!navigator.geolocation) {
      setStatus("Geolocation is not supported by your browser.", true);
      return;
    }
    setStatus("Getting your location‚Ä¶", false, true);
    navigator.geolocation.getCurrentPosition(
      function (pos) {
        requestDetails({ lat: pos.coords.latitude, lng: pos.coords.longitude });
      },
      function () {
        setStatus("Could not get your location. Try entering a place name.", true);
      }
    );
  });
})();
  </script>
</body>
</html>
